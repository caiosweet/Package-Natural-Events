type: entities # Card Principale Entità
style: |
  ha-card {
    {% if is_state('input_boolean.natural_events', 'on') and is_state('group.natural_events', 'on') %}
      border-color: {{states('sensor.natural_events_level')}};
      border-style: solid;
      border-width: 0px 1px 1px 1px;
    {% else %}
      border-width: 0px;
    {% endif %}
      background: --ha-card-background;
  }
  .card-content {
    padding: 0;
  }

entities:
  - type: custom:hui-picture-elements-card
    style: |
      @keyframes blink {
        30% {
          background: {% if is_state('group.natural_events', 'on') %} gray {% endif %};
        }
      }
      ha-card {
        --my-animation: blink 2s linear 3;
        --global-level: {% if is_state('group.natural_events', 'on') %} {{states('sensor.natural_events_level')}}; {% else %} Green;{% endif %} 
        --meteoalarm-level: {{states('sensor.meteoalarm_level')}};
        --meteoalarm-level-left: {% if (state_attr('binary_sensor.meteoalarm', 'urgency')|lower) == 'immediate' %} 5%; {% else %} 90%; {% endif %}
        --meteoalarm-type-left: {% if (state_attr('binary_sensor.meteoalarm', 'urgency')|lower) == 'immediate' %} 10%; {% else %} 95%; {% endif %}
        --my-border-style: solid;

        --my-border-width: {% if is_state('input_boolean.natural_events', 'off') %} 1px; {% else %} 0px; {% endif %}
        --my-border-color: {% if is_state('group.natural_events', 'on') %} var(--global-level); {% endif %}
        --my-background: {% if is_state('group.natural_events', 'on') %} var(--global-level); {% else %} Green;{% endif %}
        --my-color: {% if states('sensor.natural_events_level') in ['White','Yellow'] %} red; {% else %} yellow; {% endif %}
        {% if is_state('group.natural_events', 'on') %}
        --my-border-width: {% if is_state('input_boolean.natural_events', 'off') %} 1px; {% else %} 1px 0px 0px 0px; {% endif %}
        {% else %}
        --my-border-width: 0px;
        --my-color: Wihte;
        {% endif %}
        border-color: var(--my-border-color);
        border-style: var(--my-border-style);
        border-width: var(--my-border-width);
        background: var(--my-background);
      }
    image: /local/hassiohelp/pkg_natural_events/background.png
    elements:
      - type: conditional # Nessun Evento
        conditions:
          - entity: group.natural_events
            state: 'off'
        elements:
          - type: state-label
            entity: sensor.dark_sky_summary
            tap_action:
              action: call-service
              service: input_boolean.toggle
              service_data:
                entity_id: input_boolean.natural_events
            hold_action:
              action: none
            style:
              border-color: 'var(--global-level)'
              border-style: solid
              border-width: 'var(--my-border-width)'
              animation: 'var(--my-animation)'
              background-color: 'var(--global-level)'
              color: 'var(--my-color)'
              font-family: Trebuchet MS
              font-size: 120%
              font-weight: bold
              left: 0%
              opacity: 0.5
              pointer-events: auto
              right: 0%
              text-align: center
              top: 95%
              transform: 'translate(0%,-50%)'
              z-index: 98

      - type: conditional # Eventi Meteo
        conditions:
          - entity: group.meteoalert
            state: 'on'
        elements:
          - type: state-icon
            entity: sensor.meteoalarm_level
            style: 
              '--paper-item-icon-color': 'var(--meteoalarm-level)'
              left: 'var(--meteoalarm-level-left)'
              top: 20%
              z-index: 99

          - type: state-icon
            entity: sensor.meteoalarm_type
            style: 
              '--paper-item-icon-color': 'var(--meteoalarm-level)'
              left: 'var(--meteoalarm-type-left)'
              top: 20%
              z-index: 99

          - type: state-label
            entity: group.meteoalert
            prefix: 'Meteo '
            tap_action:
              action: call-service
              service: input_boolean.toggle
              service_data:
                entity_id: input_boolean.natural_events
            hold_action:
              action: none
            style:
              border-color: 'var(--global-level)'
              border-style: solid
              border-width: 'var(--my-border-width)'
              animation: 'var(--my-animation)'
              background-color: 'var(--global-level)'
              #border-radius: 6px
              color: 'var(--my-color)'
              font-family: Trebuchet MS
              font-size: 120%
              font-weight: bold
              left: 0%
              opacity: 0.5
              pointer-events: auto
              right: 0%
              text-align: center
              top: 5%
              transform: 'translate(0%,-50%)'
              z-index: 98

          - entity: binary_sensor.dpc_temporali_oggi
            image: /local/hassiohelp/pkg_natural_events/dpc_temporali_oggi.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 1
            type: image

          - entity: binary_sensor.dpc_temporali_domani
            image: /local/hassiohelp/pkg_natural_events/dpc_temporali_domani.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 1
            type: image

      - type: conditional # Eventi Geologici
        conditions:
          - entity: group.geoalert
            state: 'on'
        elements:
          - type: state-label
            entity: group.geoalert
            prefix: 'Geologico '
            tap_action:
              action: call-service
              service: input_boolean.toggle
              service_data:
                entity_id: input_boolean.natural_events
            hold_action:
              action: none
            style:
              border-color: 'var(--global-level)'
              border-style: solid
              border-width: 'var(--my-border-width)'
              animation: 'var(--my-animation)'
              background-color: 'var(--global-level)'
              color: 'var(--my-color)'
              font-family: Trebuchet MS
              font-size: 120%
              font-weight: bold
              left: 0%
              opacity: 0.5
              pointer-events: auto
              right: 0%
              text-align: center
              top: 95%
              transform: 'translate(0%,-50%)'
              z-index: 98

          - entity: binary_sensor.dpc_idraulico_oggi
            image: /local/hassiohelp/pkg_natural_events/dpc_idraulico_oggi.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 2
            type: image

          - entity: binary_sensor.dpc_idrogeologico_oggi
            image: /local/hassiohelp/pkg_natural_events/dpc_idrogeologico_oggi.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 1
            type: image

          - entity: binary_sensor.dpc_idraulico_domani
            image: /local/hassiohelp/pkg_natural_events/dpc_idraulico_domani.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 2
            type: image

          - entity: binary_sensor.dpc_idrogeologico_domani
            image: /local/hassiohelp/pkg_natural_events/dpc_idrogeologico_domani.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 1
            type: image

          - entity: binary_sensor.lastquake
            image: /local/hassiohelp/pkg_natural_events/sisma.png
            state_filter:
              'on': opacity(1)
              'off': opacity(0)
            style:
              left: 50%
              pointer-events: none
              top: 50%
              width: 100%
              z-index: 0
            type: image


  - type: custom:hui-conditional-card # NSCONDE/VISUALIZZA tutte le cards
    conditions:
      - entity: input_boolean.natural_events
        state: 'on'
    card:
      type: entities
      style: |
        ha-card {border-radius: 0px; box-shadow: none; background: none;}
      # CARDS VISUALIZZATE SOLO SE INPUT BOOLEAN NATURAL EVENTS ON!!
      entities:
        - type: custom:auto-entities # TERREMOTO conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.lastquake
                state: 'on'
          card:
            type: custom:text-divider-row # TEREMOTO divider
            text:  TERREMOTO

        - type: custom:auto-entities # TERREMOTO markdown
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.lastquake
                state: 'on'
          card:
            type: markdown
            style: >
              ha-card {background: none; border-radius: 0px; box-shadow: none; color: gray;}
              .card-content {padding: 0}
            content: >-
              {% set device_tracker = 'device_tracker.oneplus_5t' %}
              {% set data_utc = state_attr('binary_sensor.lastquake', 'publication_date') %}
              {% set magnitudo = (state_attr('binary_sensor.lastquake', 'magnitude')|float) if not none else '0' %}
              {% set code = {0:'White', 1:'Green', 2:'Yellow', 3:'Orange', 4:'Red'} %}
              {% set color = code[state_attr('binary_sensor.lastquake', 'level')|int] %}
              {% set lat = state_attr('binary_sensor.lastquake', 'latitude') %}
              {% set lon = state_attr('binary_sensor.lastquake', 'longitude') %}
              <font color={{color}}>{{as_timestamp(data_utc)|timestamp_custom ('%H:%M:%S del %d-%m-%Y')}}</font>


              Un terremoto di magnitudo <font color={{color}}> {{magnitudo}} </font> 
              è avvenuto nella zona: [{{state_attr('binary_sensor.lastquake', 'region')}}](https://www.google.com/maps/search/?api=1&query={{state_attr('binary_sensor.lastquake', 'latitude')}},{{state_attr('binary_sensor.lastquake', 'longitude')}})
              a <font color={{color}}> {{state_attr('binary_sensor.lastquake', 'distance')}} </font> km da casa,
              con coordinate geografiche (lat, lon) {{lat}}, {{lon}}. 
              
              Tu ti trovi a {{distance(lat, lon, device_tracker) | round(1) if (lat and lon) else none}} km dall'epicentro.


              {% if magnitudo >= 3|int %}
              [Shakemap]({{state_attr('binary_sensor.lastquake', 'image_url')}}) ~ 
              [PGA](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/pga.jpg) ~ 
              [PGV](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/pgv.jpg) ~ 
              [TvMap](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/tvmap.jpg) ~ 
              [TvMap2](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/tvmap_bare.jpg) ~ 
              [HaiSentitoIlTerremoto](http://eventi.haisentitoilterremoto.it/{{state_attr('binary_sensor.lastquake', 'short_id')}}/{{state_attr('binary_sensor.lastquake', 'short_id')}}_mcs.jpg)


              <img style="border: 2px solid {{color}};" src="{{state_attr('binary_sensor.lastquake', 'image_url')}}"/>
              {% endif %}


              [INGV](http://terremoti.ingv.it/) ~ [HaiSentitoIlTerremoto Web](http://www.haisentitoilterremoto.it/)

        - type: custom:hui-conditional-card # TERREMOTO geolocation
          conditions:
            - entity: binary_sensor.lastquake
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Posizione Geografica'
              card:
                type: map
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                entities:
                  - zone.geoalert
                geo_location_sources:
                  - ingv_centro_nazionale_terremoti
                dark_mode: true
                default_zoom: 10
                aspect_ratio: 100%

        - type: custom:auto-entities # DPC conditional
          show_empty: false
          filter:
            include:
              - entity_id: "*binary_sensor.dpc_*"
                state: 'on'
          card:
            type: custom:text-divider-row # DPC divider
            text: PROTEZIONE CIVILE

        - type: custom:auto-entities # DPC markdown
          show_empty: false
          filter:
            include:
              - entity_id: "*binary_sensor.dpc_*"
                state: 'on'
                attributes:
                    level: "> 0"
          card:
            type: markdown
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
              .card-content {padding: 0}
            content: >
              {% set color = {0:'White', 1:'Green', 2:'Yellow', 3:'Orange', 4:'Red'} %}
              {% for e in config.entities %}


              <font color= {{color[state_attr(e.entity, 'level')|int]}}>
              <ha-icon icon="{{ 'mdi:numeric-' ~ state_attr(e.entity, 'level')|int ~ '-box'}}" style="width: 36px; height: 36px;"></ha-icon> 
              {{state_attr(e.entity, 'friendly_name')}} - {{state_attr(e.entity, 'allerta')}} {{state_attr(e.entity, 'info')}}</font>
              {%- endfor %}


              [Protezione Civile](http://www.protezionecivile.it/home) ~ [Vigilanza Meteo](http://www.protezionecivile.gov.it/dettaglio/-/journal_content/56/20182/1131180?refererPlid=42041&controlPanelCategory=current_site.content)
              ~ [Criticità Idro](http://www.protezionecivile.gov.it/attivita-rischi/meteo-idro/attivita/previsione-prevenzione/centro-funzionale-centrale-rischio-meteo-idrogeologico/previsionale/bollettini-criticita/bollettino-odierno) ~ [Radar](http://www.protezionecivile.gov.it/radar-dpc)

        - type: custom:auto-entities # BURZE conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.burze_storms_nearby
                state: 'on'
          card:
            type: entities
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
              .card-content {padding: 0;}
            show_header_toggle: false
            entities:
              - type: custom:text-divider-row
                text: BURZE

              - type: custom:auto-entities # BURZE markdown
                show_empty: false
                filter:
                  include:
                    - entity_id: binary_sensor.burze_storms_nearby
                      state: 'on'
                card:
                  type: markdown
                  style: |
                    ha-card {background: none; border-radius: 0px; box-shadow: none;}
                  content: >-
                    <font color= #4caf50>{{state_attr('binary_sensor.burze_storms_nearby', 'number')}}</font><font color= yellow><ha-icon icon="mdi:flash" style="width: 24px; height: 24px; transform: rotate(35deg);"></ha-icon></font> in <font color= #4caf50> {{state_attr('binary_sensor.burze_storms_nearby', 'period')}}</font> minuti.
                    Il più vicino è caduto a <font color= #4caf50> {{state_attr('binary_sensor.burze_storms_nearby', 'distance')}} Km </font> a <font color= #4caf50> {{states('sensor.burze_direction')}} </font>
                    </font> da casa.


                    [Burze](https://burze.dzis.net) ~ [Blitzortung](http://map.blitzortung.org/#5.11/43.00/13.00) 

        - type: custom:auto-entities # METEOALARM divider
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.meteoalarm
                state: 'on'
          card:
            type: custom:text-divider-row
            text: METEO ALARM

        - type: custom:auto-entities # METEOALARM markdown conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.meteoalarm
                state: 'on'
          card:
            type: markdown
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
            content: >
              ## <font color= {{states('sensor.meteoalarm_level')}}> <ha-icon icon="{{state_attr('sensor.meteoalarm_level', 'icon')}}" style="width: 36px; height: 36px;"></ha-icon> </font>
              <font color= {{states('sensor.meteoalarm_level')}}> <ha-icon icon="{{state_attr('sensor.meteoalarm_type', 'icon')}}" style="width: 36px; height: 36px;"></ha-icon></font>
              <font color= {{states('sensor.meteoalarm_level')}}> {{state_attr('binary_sensor.meteoalarm', 'event')}}
              </font><font color= grey> {{state_attr('binary_sensor.meteoalarm', 'urgency')}} </font>
              
              {% set start = state_attr('binary_sensor.meteoalarm', 'effective') %}
              {% set end = state_attr('binary_sensor.meteoalarm', 'expires') %}
              <font><center> {{as_timestamp(start)|timestamp_custom ('Valido dalle ore **%H:%M** del **%d/%m**')}}
              {{as_timestamp(end)|timestamp_custom (' alle ore **%H:%M** del **%d/%m**')}}</font></center>


              **Titolo**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'headline')}} </font>


              **Descrizione**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'description')}} </font>


              **Istruzioni**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'instruction')}} </font>


              [MeteoAlarm]({{state_attr('binary_sensor.meteoalarm', 'web')}}) 

        - type: custom:hui-conditional-card # MAPPA Giorno/Notte
          conditions:
            - entity: group.natural_events
              state: 'off'
          card:
              type: picture-entity
              style: |
                ha-card {
                  border-radius: 0px; 
                  border: solid 1px var(--accent-color);
                  box-shadow: none;
                  margin: 16px;
                }
              entity: sun.sun
              state_image:
                "above_horizon": https://api.sat24.com/animated/IT/visual/3/Central%20European%20Standard%20Time/3065655' width=845 height=615
                "below_horizon": https://api.sat24.com/animated/IT/infraPolair/3/Central%20European%20Standard%20Time/2523464' width=845 height=615

        - type: custom:hui-conditional-card # MAPPE meteo
          conditions:
            - entity: group.meteoalert
              state: 'on'
            - entity: input_select.meteo_map
              state_not: 'Nessuna'
          card:
            type: picture-entity
            style: |
              ha-card {
                border-radius: 0px; 
                border: solid 1px var(--accent-color);
                box-shadow: none;
                margin: 16px;
              }
            title: Nuvole
            entity: input_select.meteo_map
            tap_action:
              action: call-service
              service: input_select.select_next
              service_data:
                entity_id: input_select.meteo_map
            hold_action:
              action: call-service
              service: input_select.select_previous
              service_data:
                entity_id: input_select.meteo_map
            state_image:
              "Nuvole e Sole": https://api.sat24.com/animated/IT/visual/3/Central%20European%20Standard%20Time/3065655' width=845 height=615
              "Nuvole Infrared": https://api.sat24.com/animated/IT/infraPolair/3/Central%20European%20Standard%20Time/2523464' width=845 height=615
              "Pioggia": https://api.sat24.com/animated/IT/rainTMC/3/Central%20European%20Standard%20Time/3872070' width=845 height=615
              "Neve": https://api.sat24.com/animated/EU/snow/3/Central%20European%20Standard%20Time/4614822' width=845 height=615 
              "Burze": https://burze.dzis.net/italia_fulmine_lebhaft_gruppi_ne.gif
              "WWLLN": https://wwlln.net/WWLLN_movies/Movie_of_Lightning_in_EurAfrica_BIG.gif
            entities: 
              - entity: input_select.meteo_map

        - type: custom:hui-conditional-card # IFRAME wwlln
          conditions:
            - entity: binary_sensor.burze_storms_nearby
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Posizione Geografica'
              card:
                type: map
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                entities:
                  - zone.meteoalert
                geo_location_sources:
                  - wwlln
                dark_mode: true
                default_zoom: 8
                aspect_ratio: 100%

        - type: custom:hui-conditional-card # IFRAME windy
          conditions:
            - entity: group.meteoalert
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Windy Alert'
              card:
                type: iframe
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                aspect_ratio: 100%
                url: https://embed.windy.com/embed2.html?lat=42.000&lon=12.000&zoom=5&level=surface&overlay=capAlerts&menu=&type=map&location=coordinates&detail=&detailLat=42.000&detailLon=12.000
